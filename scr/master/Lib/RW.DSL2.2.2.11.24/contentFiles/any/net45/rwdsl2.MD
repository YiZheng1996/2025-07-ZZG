# 润伟基于Antlr的DSL v2

````
使用须知：
1、请先安装antlr4 vs插件。
	方法：扩展-管理扩展-联机-输入“antlr”
2、下载antlr4第三方插件。
	方法：选择项目-右键“管理nuget程序包”-浏览-输入"antlr4"-选中"Antlr4"-点击“安装”。

````

* 
* 解析规则，单行解析模型
* 
* 自动试验过程的规则文件
* 支持关键字：
* 打开：打开某个模块的开关量属性；
* 关闭：关闭某个模块的开关量属性；
* 脉冲：给一个脉冲信号到一个模块的属性。
* 等待：延迟一定的时间，支持单位自动换算；
* 定义：定义某个变量；
* 设置：设置某个模块的模拟量值；
* 检测：直到条件成立则继续运行；
* 打印：打印指定的内容，只做调试用；
* 调用：可以调用指定的方法，一般用于需要指定字符串的模块
* 如果：判断逻辑条件是否成立。
* 否则：配合“如果”指令，如果指令不匹配，则进入否则指令。
* 循环：根据条件执行多次循环体的内容。
* 跳出：配合循环使用，直接跳出循环，不判断循环条件。
* 同步：用于多个过程同时执行的互锁逻辑。
* 
* '#':注释，允许注释一行代码

* DSL模块说明
* 可以使用*.ini文件进行模块定义；
* 如：
```
[模块A]
Type=OPC
功能a=Channel1.Device1.DO.DO01
功能b=Channel1.Device1.DO.DO02
[模块B]
Type=Modbus
PortName=COM1
...
功能a=400100
功能b=H000001
功能c=H400002[10],float,2
[模块C]
Type=SerialPort(SerialPort正在紧张开发中)
功能a=?123
功能b=0x11 0x12 0x13 0x14
[模块D]
Type=TCP(TCP驱动暂未定义)
功能a=...
功能b=...
```

##### 待实现的功能
 1. 工具化：增加编译和编写的小工具。 已有
 2. 模块化滤波； 已实现
 3. 驱动底层完善。
 4. +=，*=，-=，/=的代码实现。 **2019-09-24 已实现。**
 5. 底层驱动SerialPortDriver实现与测试。
 6. 底层驱动TCPDriver实现与测试。



## 更新记录：

### 2022-07-26 2.2.11.19-24
* 修复：修复‘线程/同步’语法不能在“如果”语法之内的问题。
* 修复：‘异步’语法中，调用dsl方法，由于参数为空导致报错的问题。
* 修复：‘线程 停止('xxx')’时，当线程未运行会导致报错的问题。
* 新增：“线程”新增全部停止的功能。
* 修复：修复“线程 停止”未正确停止线程的问题。
* 修复：修复 定义线程时过多时，在运行时，可能会出现“给定关键字，不在字典中”的问题。

### 2022-07-25 2.2.11.18
* 修复：修复使用“同步”时，提示“未将对象的引用设置到对象的实例”的问题
* 修复：修复主线程急停后，异步子线程继续执行的问题。

### 2022-05-12 2.2.11.17
* 修复：修复使用DSLModule写入数组时，会提示Convert错误的问题。

### 2022-03-07 2.2.11.15
* 修复：修复字符串比较时，使用“!=”比较字符串一直返回false的问题。

### 2022-03-02 2.2.11.13
* 修复：修复空字符串会报错的问题。
* 修复：修复“如果 空字符串”一直返回false的问题。

### 2021-12-28 2.2.11.12
* 修复：修复“--”语法变成了+1的语法的问题。
* 新增：新增了$substr 语法截取函数的功能。

### 2021-09-30
#### 2.2.11.10
* 修复：修复调用无参函数时，可能会提示报错的问题。
* 优化：相同DSL代码，只会分析语法树一次，提高了执行效率。
* 优化：导入DSL函数后，进行调用只会产生一个DSL对象，而不会每次调用产生一个对象，效率提升。

### 2021-09-28
#### 2.2.11.9
* 优化：优化了“采集”模块的使用，启用时，自动增加采集模块。
* 调整：调整了"线程 关闭采集"改为“采集 关闭('@var')”
* 调整：调整了“线程 采集状态”改为“采集 采集状态('@var')”

### 2021-09-25
#### 2.2.11.8
* [修复]: 修复使用等待语法中“带单位的数组变量”时，等待不正确的问题。

### 2021-09-22
#### 2.2.11.7
* 新增：系统提示增加了“是否”、“是否取消”、“重试”、“中止重试”的提示信息。
* 修复：修复“打开 模块 属性('123')”时，会报错的问题。

### 2021-09-19
#### 2.2.11.5
* 新增：针对模块新增了“属性”和“方法”两个方法，可用于动态调用属性和方法。

### 2021-09-07
#### 2.2.11.4
* 准备增加：准备增加了对字典的支持。
* 新增：增加了“区间”函数，可比较值是否在区间范围内，并返回true、false；
### 2021-09-06
#### 2.2.11.3
* 优化：使用扩展方法，替换了部分代码。
* 准备增加：为2.3做准备，使用Command指令来执行DSL而不是全部在ProcedureVisitor里面。
* 优化：IDSLIterator中增加了Sets方法，而Vars、Modules中存在对应的AddXXs方法不合理，全部改为Sets并过期标记。
* 修复：“等待”、“退出”、“打印”指令会多次执行代码的问题，已排查全部，不会再有此问题。 如“等待 模块 属性”这样会执行2次。
### 2021-09-04
#### 2.2.11.2
* 修复：修复上一版本中，使用DisplayName属性命名的函数调用报错的问题。
#### 2.2.11.1
* 大优：
	1. 调整：单位调整为只支持时间单位（以后专门针对单位进行扩展）
	2. 调整：函数调用进行整体性优化，不在多次写相同或类似代码。
	3. 调整："++"和"--"表达式优化，可作为“值”进行传递和引用。
	4. 调整：赋值表达式，不能作为“值”进行传递。
	5. 优化：数组调整，变量数组、模块数组单独定义和引用。
	6. 优化：bool值表达式进行优化，现支持绝对不区分大小写的“true”和“false”写法。
	7. 优化：模块的调用和变量的调用支持无限级联的调用。
### 2021-09-01
#### 2.2.11.0
* 新增：增加了自定义函数功能。
* 新增：增加了函数参数命名功能。
* 优化：优化了数组相关语法，函数、事件调用。
* 新增：IDSLIterator 接口新增了Sets方法，可设置集合。
* 优化：DSL执行时，如果是函数调用报错，不会出现“调用目标程序错误”的异常，而是函数调用完的异常。

### 2021-08-25
#### 2.2.10.9
* 新增：新增了运算符"&="和"|="。
* 优化：优化了赋值的计算过程，语法更加轻量化。
* 优化： 优化了DSLModule的AOP方法。
### 2021-08-19
#### 2.2.10.8
* 修复：修复"$lte"指令比较一直返回true的问题，同样的“$gt/$gte/$eq/$neq”等都有相同问题。

### 2021-08-18
#### 2.2.10.7
* 修复：修复重复创建“采集”线程时，可能导致采集报错的问题。
* 优化：优化创建“采集”线程时，如果采集对象为数组，则只会显示一个日志的功能。
* 优化：优化“采集”的行为日志，对用户更加友好。

### 2021-08-17
#### 2.2.10.6
* 优化：系统对内置函数增加了中文调用方式，如“$avg”可写成“$平均值”,"$max"可写成“$最大值”更多请参考文档对照表。
* 新增：增加了排序的内置函数，“$sort”、“$sortdesc”或“$正序”、“$倒序”。

### 2021-08-13
#### 2.2.10.5
* 修复：采集模块，采集集合点时，会出现keyNotFound异常的问题。
### 2021-08-12
#### 2.2.10.4
* 修复：修复采集线程（初始化多个）时，可能会出现Dictionary线程错误错误的问题。

### 2021-08-09
#### 2.2.10.3
* 新增：增加了滤波算法，“极差值”、“平均偏差值”、“标准差值”计算公式，可用于计算温升等统计函数。
* 优化：优化了滤波算法结构，更加便于扩展。
* 新增：新增了关闭单个采集线程的方法，“线程 关闭采集('@变量名')”

### 2021-08-06
### 2.2.10.2
* 新增：新增了比较函数($lt,$lte,$gt,$gte,$eq,$neq)，可比较 数值与数值，数组与数值，并返回结果。
### 2.2.10.1
* 新增：采集状态可控制，试验完毕自动关闭，也可“关闭 线程 采集状态”
### 2.2.10
* 新增：新增了采集指令，可定期写入指定变量，支持变量和数组。根据返回类型决定。
* 新增：新增了最大值、最小值、滑动平均值等滤波算法。可结合采集指令获取和设置。

### 2021-08-05
#### 2.2.9.5
* 修复：修复DSLModule默认给定了SetLocal参数，导致读取的SetLocal属性不可用的问题。

### 2021-07-28
####2.2.9.4
* 修复：引用函数并执行时，无法停止的问题。

### 2021-07-23
#### 2.2.9.3
* 优化：优化模块调用时，如果为空对象时的友好提示。

### 2021-07-19
#### 2.2.9.2
* 优化：当调用子函数报错时提示“调用目标错误”的异常，改为InnerException错误。
#### 2.2.9.1
* 优化：优化DSL写Ini对象时，当属性未找到时的错误提示问题。

### 2021-07-17
#### 2.2.9.0
* 新增：新增了语法支持，支持“模块[0].属性”的模块索引语法，支持数组和泛型
* 新增：新增了语法支持，支持“模块 我的模块=模块[0]”的模块引用语法，支持数组和泛型

#### 2021-07-14
##### 2.2.8.4
* 修复：修复使用“检测”指令不能跳过等待的问题。

#### 2021-07-05
##### 2.2.8.3
* 升级：由于底层升级到3.1.x.x导致引用了dsl的页面无法加载的问题。

#### 2021-06-23
##### 2.2.8.2
* 新增：新增"全局计时器"模块。
* 修复：优化"计时器"调整为DSL对象专用，不会与其他线程中的计时器互相影响。

#### 2021-06-19
##### 2.2.8.1
* 修复：修复ThreadData.Create主线程时，在多线程情况下可能会报错的问题。

#### 2021-06-09
##### 2.2.8
* 新增：新增了模块引用语法，“模块 名称='模块名'”或“名称='模块名'”，支持变量引用，变量计算。

#### 2021-05-12
##### 2.2.7
* 新增：新增了IFilter接口，用于支持滤波算法（自带滑动属性）。
* 新增：增加了多个滤波算法，当前共计有:
	滑动滤波(Smooth)
	滑动均方根滤波(RMS)
	平均值滤波(Average)
	中位值滤波(Middle)
	可在模块定义中使用这些滤波方法。(Filter=Smooth，支持自定义滤波法，Filter=RW.XXX.XXX.XXX)
#### 2021-05-08
##### 2.2.6
* 修复：修复使用$format格式化日期时，可能会报错的问题。
#### 2021-04-27
##### 2.2.5
* 修复：224版本中，string变量也默认变成0了。
##### 2.2.4
* 优化：将默认数据类型调整为Double，即当出现Default时，默认使用double进行判断。
##### 2.2.3
* 修复：修复调用参数为object类型的方法时，获取数组索引值返回结果为string的问题。

#### 2021-04-23
##### 2.2.1
* 优化：调试器增加了多个事件。状态改变、断点改变、开始、停止等事件。
##### 2.2.0
* 新增：增加调试器功能。

#### 2021-04-22
##### 2.1.25
* 优化：DSLModule 读取时，不使用缓存变量（内部仍然使用了缓存变量）。
##### 2.1.24
* 优化：DSLModuleHelper支持自动连接OPC开关（Create时），最终InitModules时，将会触发连接驱动的工作。
##### 2.1.23
* 预增加：动作历史，用于动作回放和记录日志；DSL调试代码；
* 优化：使用ini文件初始化模块和驱动时，使用了单例模型导致无法创建新的模块的问题。（驱动也同理）

#### 2021-04-20
##### 2.1.22
* 优化：当调用方法时，如果参数类型是object，将根据数据类型自动转换。（原来全部采用string类型进行传递）

#### 2021-04-19
##### 2.1.21
* BUG：修复使用“循环 跳出”语法时，会影响后面的“如果”、“检测”等语法，也将直接跳过的问题。

#### 2021-04-17
##### 2.1.17
* 优化：函数调用的语法优化，现已支持括号的方式。如$funcName(p1,p2,p3)，对已有方式也进行了兼容"$funcName p1 p2 p3"
* 修复：设置模块值可能出错的问题。
* 优化：优化了函数调用日志，显示所有的参数信息。
##### 2.1.18
* 优化：使用领域特性语言调用领域特性语言时，日志未包含过程名称的问题。
##### 2.1.19
* 优化：当执行代码抛出异常时，日志内容仍然包含结束块。
##### 2.1.20
* 优化：优化rwdsl函数的引用支持变量，而不是仅仅是字符串。
* 修复：修复使用模块 属性++时，无法修改的模块值的问题。（类似的--语法雷同）

#### 2021-04-16
##### 2.1.16
* 优化：增加了过程名称的显示，日志更加友好。
* 优化：增加了@当前用户 的系统变量。

#### 2021-04-13
##### 2.1.15
* 优化：优化了如果块和循环块，代码运行中突然退出时，仍然会执行剩余部分代码的问题。
##### 2.1.14
* 优化：优化了代码行数和日志内容的提示信息。
* 优化：在特殊条件下，当日志记录关闭时，仍然能记录日志的问题。
##### 2.1.13
* 优化：优化DSLModuleHelper的异常提示内容。
* 优化：Values新增string参数的构造函数重载。
##### 2.1.12
* 修复：修复浮点数运算减法和除法时，会出现0.0000001的偏差问题。

#### 2021-04-11
##### 2.1.11
* 修复：修复循环语法中，使用'退出'指令，循环语法仍然继续执行的问题。
* 新增：‘退出’语法新增了内容，可以类似'错误'语法，在执行[END]程序后，提示错误。意为：退出后提示错误内容。
* 优化：退出、错误语法都增加了日志记录功能。

#### 2021-04-09
##### 2.1.9
* 修复：修复当使用“模块 自动”时，会无法读取自动状态的问题。
##### 2.1.10
* 修复：修复“脉冲”、“关闭”指令的“否则”部分不能执行的问题。
* 优化：打开、关闭、脉冲指令默认的动作超时时间为1秒。
* 优化：获取变量可以使用泛型获取并转换类型。

#### 2021-04-01
##### 2.1.8
* 重大修复：修复了DSL中字符串比较一直返回true的问题。
* 优化：优化DSL模块无法写string类型的值的问题。
* 优化：ValueTypeEnums重新定义了数值和排序，数值越大范围越大，同时比较时自动转换成大类型。

#### 2021-03-30
##### 2.1.7
* 新增：增加了tostr函数格式化数值、日期的功能。
##### 2.1.7.2
* 修复：主线程结束可能会将子线程清空，导致子线程设置错误的问题。
* 修复：移除了中断语法（设置时）。

#### 2021-03-29
##### 2.1.6
* 新增：新增线程开启方法、关闭方法。
* 新增：线程块增加了“自动”标识，支持自动启动和不启动。
* 新增：添加日志方法增加了一个带异常码的重载。
* 新增：rwdsl函数的avg函数新增了一个参数重载，支持自动保留小数位。
* 优化：优化了Log可以会触发两次记录的问题。

#### 2021-03-25
##### 2.1.5
* 新增：新增了tostr和toint函数。
* 优化：函数的参数判断优化。
* 优化：滑动滤波算法优化，支持去头去尾的功能。

#### 2021-03-03 2.1.4
* 优化：优化DSL滤波为滑动滤波算法，并增加了忽略数量属性（默认为3），采集数量默认为15个。

#### 2021-02-26 2.1.3.9
* 修复：修复函数定义的大小写及调用问题。

#### 2020-12-30 2.1.3.8
* 优化：注释文件进行了优化。

#### 2020-12-30 2.1.3.7
* 优化：AO量支持零点增益后写入的功能。
* 调整：调整了AOP切面的注入方法。

#### 2020-12-29 2.1.3.6
* 优化：DSLModule类增加了AOP切面编程的方法，允许进行分段零点增益设定。
* 优化: DSLModuleHelper增加了缓存，同模块，只会初始化一次。
* 优化：DSLFuncntion增加了参数数量判断。

#### 2020-12-17 2.1.3.4
* 优化：初始化模块增加了日志记录。
* 优化：可能无法创建模块的问题。
* 优化：当调用函数的参数数量不匹配时，给出友好提示。

#### 2020-12-08 2.1.0
* 优化：打开、关闭、脉冲、上升沿、下降沿的动作，支持通用的参数"超时"、"间隔"、"检测"。
    示例：
打开 模块 属性 [超时=3 秒,间隔=10 毫秒,检测=模块 属性2]
 打印 '设置成功'
否则
 打印 '设置超时'

#### 2020-12-07 2.1.0
* 新增：增加上升沿、下降沿的命令功能。
* 优化：Values增加了true、false、!=、!运算符重载，支持bool运算。
* 新增：将打开、关闭、脉冲、上升沿、下降沿动作合并，支持块语法和else语法。

#### 2020-12-04 2.0.5
* 修复：当读取领域模块中的“值”属性时，如果其中含有非数字变量会导致报错的问题。
* 调整：库名称调整成，rwdsl2，防止新旧程序的dll引用冲突。（如果同时引用1-2代还是会有问题，必须引用一个版本）

#### 2020-12-03 2.0.4
* 修复：当*.ini的模块配置中，配置了Filter属性，同时包含有bool类型的属性，导致数据读取错误的问题。

#### 2020-11-28 2.0.3
* 修复：循环模块中，使用时间模块的功能。

#### 2020-11-27 2.0.2
* 修复：修复脉冲指令，如果当前信号=true时，不会触发上升沿的问题。（只写了2次，true,false）

#### 2020-11-26 2.0.0
* 优化：合并了RWDSL